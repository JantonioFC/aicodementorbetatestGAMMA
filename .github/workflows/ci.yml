name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

# Concurrency control:
# - For PRs: Cancel in-progress runs when new commits are pushed
# - For main: Allow all runs to complete (don't cancel on rapid commits)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || 'mock-key-for-ci' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci --legacy-peer-deps

    - name: Lint
      run: npm run lint
      continue-on-error: true # Don't block build on lint warnings for now

    - name: Build Application
      run: npm run build
      env:
        NEXT_PUBLIC_E2E_TEST_MODE: 'true'

    - name: Security Audit (Dependencies)
      run: npm audit --audit-level=critical
      continue-on-error: true # Report but don't block yet

    - name: Package Build Artifacts
      run: tar -cf /tmp/next-build.tar .next/

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: next-build-${{ github.run_id }}
        path: /tmp/next-build.tar
        retention-days: 1

    - name: Run Unit Tests
      run: npm test

    - name: Test Health Report
      run: node scripts/test-health.js
      continue-on-error: true

  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: build-and-test
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || 'mock-key-for-ci' }}
      JWT_SECRET: ${{ secrets.JWT_SECRET || 'ci-test-secret-minimum-32-chars' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci --legacy-peer-deps

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: next-build-${{ github.run_id }}

    - name: Extract Build Artifacts
      run: tar -xf next-build.tar

    - name: Prepare Standalone Server
      run: |
        # Copy static assets into standalone directory (required for standalone mode)
        # Corrected: copy into .next/ and current dir of standalone to match Next.js expectations
        mkdir -p .next/standalone/.next
        cp -r .next/static .next/standalone/.next/
        cp -r public .next/standalone/
        echo "‚úÖ Assets copied to standalone directory"

    - name: Verify Asset Structure
      run: |
        echo "=== Standalone Directory Structure ==="
        ls -R .next/standalone/.next/static | head -n 20
        echo "---"
        ls -R .next/standalone/public | head -n 10
        echo "---"
        find .next/standalone -name "server.js"

    - name: Initialize Database & Seed Demo User
      run: |
        node scripts/init-sqlite.js --force
        node scripts/create-demo-user.js
        # Copy fresh database into standalone directory
        # (standalone server uses process.cwd() = .next/standalone/)
        mkdir -p .next/standalone/database/sqlite
        cp database/sqlite/curriculum.db .next/standalone/database/sqlite/curriculum.db
        echo "‚úÖ Database copied to standalone directory"

    - name: Verify Auth API
      run: |
        cd .next/standalone && E2E_TEST_MODE=true GEMINI_API_KEY=$GEMINI_API_KEY JWT_SECRET=$JWT_SECRET node server.js > /tmp/server.log 2>&1 &
        SERVER_PID=$!
        sleep 5
        echo "=== Login test ==="
        curl -s -v -X POST http://localhost:3000/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"email":"demo@aicodementor.com","password":"demo123"}' 2>&1
        echo ""
        echo "=== Asset accessibility check ==="
        # Look for a static asset file (CSS or JS) in .next/static
        ASSET_FILE=$(find .next/standalone/.next/static -name "*.css" -o -name "*.js" 2>/dev/null | head -n 1 || true)
        if [ -n "$ASSET_FILE" ]; then
          # Build the URL path relative to .next/standalone/.next/
          REL_PATH="${ASSET_FILE#.next/standalone/.next/}"
          curl -s -I "http://localhost:3000/_next/${REL_PATH}"
        else
          echo "‚ö†Ô∏è No static asset found for check"
        fi
        echo ""
        echo "=== Server logs (stdout+stderr) ==="
        cat /tmp/server.log
        echo ""
        echo "=== DB check ==="
        node -e "const D=require('better-sqlite3');const d=new D('database/sqlite/curriculum.db');console.log(d.prepare(\"SELECT name FROM sqlite_master WHERE type='table' AND name IN ('refresh_tokens','user_profiles')\").all());d.close();"
        kill $SERVER_PID 2>/dev/null || true
        # Clean up anything else on port 3000
        lsof -ti:3000 | xargs kill -9 2>/dev/null || true
    - name: Ensure Port 3000 is Free
      run: |
        # Forceful cleanup of any lingering processes
        lsof -ti:3000 | xargs kill -9 2>/dev/null || true
        echo "‚úÖ Port 3000 checked and cleared"

    - name: Run E2E Tests
      run: npx playwright test --retries=2
      env:
        CI: true
        NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN || '' }}
        NEXT_PUBLIC_E2E_TEST_MODE: 'true'
        DATABASE_URL: 'file:./test.db'

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ github.run_id }}
        path: playwright-report/
        retention-days: 7

    - name: Upload Test Screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-screenshots-${{ github.run_id }}
        path: test-results/
        retention-days: 7

    - name: Comment PR with Test Results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          // Try to get test summary
          let summary = '## üß™ E2E Test Results\n\n';
          
          try {
            // Check if playwright-report exists
            if (fs.existsSync('playwright-report/index.html')) {
              summary += '‚úÖ Playwright report generated\n';
              summary += `üìé [Download Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            }
          } catch (e) {
            summary += '‚ö†Ô∏è Could not generate test summary\n';
          }
          
          summary += `\n*Run ID: ${{ github.run_id }}*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
